<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brookfield Events Calendar [Alpha]</title>
<link rel="stylesheet" href="styles.css">
<style>
.reminder-highlight {
  animation: highlightAnim 2s ease;
}
@keyframes highlightAnim {
  0% { background-color: #ffff99; }
  100% { background-color: #f0f0f0; }
}
.series-label {
  font-size: 0.8em;
  color: #555;
  margin-left: 5px;
}
</style>
</head>
<body>
<div class="wrapper">
  <h1>Brookfield Events Calendar [Alpha]</h1>

  <div class="container-calendar">
    <h3 id="monthAndYear"></h3>
    <div class="button-container-calendar">
      <button id="previous">‹</button>
      <button id="next">›</button>
    </div>
    <table class="table-calendar">
      <thead id="thead-month"></thead>
      <tbody id="calendar-body"></tbody>
    </table>
    <div class="footer-container-calendar">
      <label>Jump To:</label>
      <select id="month"></select>
      <select id="year"></select>
    </div>
  </div>

  <div id="reminder-section">
    <h3>Events & Reservations</h3>
    <ul id="reminderList"></ul>
  </div>
</div>

<script>
let currentDate = new Date();
let events = [];

async function loadEvents() {
  try {
    const res = await fetch("/api/getEvents");
    events = await res.json();
    renderCalendar();
    renderEventList();
  } catch (err) { console.error(err); }
}

function renderEventList() {
  const ul = document.getElementById("reminderList");
  ul.innerHTML = "";

  const m = currentDate.getMonth() + 1;
  const y = currentDate.getFullYear();

  const monthEvents = events
    .filter(e => {
      const [ey, em] = e.date.split("-").map(Number);
      return ey === y && em === m;
    })
    .sort((a,b)=> new Date(a.date) - new Date(b.date));

  monthEvents.forEach(e=>{
    let cls="event-default";
    if(e.eType==="socialCommitteeEvent") cls="event-social";
    else if(e.eType==="smallGroup") cls="event-small";
    else if(e.eType==="reservedPaid") cls="event-paid";
    else if(e.eType==="noSocialnoPaid") cls="event-large";

    const li=document.createElement("li");
    li.className="reminder-item";
    li.dataset.key=`${e._id}-${e.date}`;

    li.innerHTML=`
      <div class="reminder-header ${cls}">
        ${e.title} – ${e.date} ${e.seriesId ? '<span class="series-label">(Series)</span>':''}
      </div>
      <div class="reminder-details">
        <div>${e.startTime||""} ${e.endTime||""}</div>
        <div>${e.contactName||""} ${e.contactInfo||""}</div>
        <div>${e.description||""}</div>
      </div>
    `;

    li.querySelector(".reminder-header").onclick = ()=>{
      li.querySelector(".reminder-details").classList.toggle("show");
    };

    ul.appendChild(li);
  });
}

function renderCalendar() {
  const month=currentDate.getMonth();
  const year=currentDate.getFullYear();

  document.getElementById("monthAndYear").textContent =
    currentDate.toLocaleString("default",{month:"long"})+" "+year;

  document.getElementById("thead-month").innerHTML =
    "<tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>";

  const body=document.getElementById("calendar-body");
  body.innerHTML="";

  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();

  let date=1;
  for(let i=0;i<6;i++){
    const row=document.createElement("tr");
    for(let j=0;j<7;j++){
      const cell=document.createElement("td");
      if((i===0&&j<firstDay)||date>daysInMonth){cell.innerHTML="";}
      else{
        cell.textContent=date;
        const dStr=`${year}-${String(month+1).padStart(2,"0")}-${String(date).padStart(2,"0")}`;
        const dayEvents=events.filter(e=>e.date===dStr);
        if(dayEvents.length){
          const dots=document.createElement("div");
          dots.className="event-dots";
          dayEvents.forEach(e=>{
            const dot=document.createElement("span");
            let cls="event-default";
            if(e.eType==="socialCommitteeEvent") cls="event-social";
            else if(e.eType==="smallGroup") cls="event-small";
            else if(e.eType==="reservedPaid") cls="event-paid";
            else if(e.eType==="noSocialnoPaid") cls="event-large";
            dot.className="event-dot "+cls;
            if(e.seriesId) dot.title="(Series)";
            dot.onclick=ev=>{
              ev.stopPropagation();
              const li=document.querySelector(`[data-key='${e._id}-${e.date}']`);
              if(li){ li.scrollIntoView({behavior:"smooth"}); li.classList.add("reminder-highlight");
                setTimeout(()=>li.classList.remove("reminder-highlight"),2000);
              }
            };
            dots.appendChild(dot);
          });
          cell.appendChild(dots);
        }

        cell.onclick=()=>{
          document.querySelectorAll(".reminder-details").forEach(d=>d.classList.remove("show"));
          dayEvents.forEach(e=>{
            const li=document.querySelector(`[data-key='${e._id}-${e.date}']`);
            if(li) li.querySelector(".reminder-details").classList.add("show");
          });
          if(dayEvents.length){
            const li=document.querySelector(`[data-key='${dayEvents[0]._id}-${dayEvents[0].date}']`);
            if(li) li.scrollIntoView({behavior:"smooth"});
          }
        };
        date++;
      }
      row.appendChild(cell);
    }
    body.appendChild(row);
    if(date>daysInMonth) break;
  }
}

// NAVIGATION
document.getElementById("previous").onclick=()=>{
  currentDate.setMonth(currentDate.getMonth()-1);
  renderCalendar(); renderEventList();
};
document.getElementById("next").onclick=()=>{
  currentDate.setMonth(currentDate.getMonth()+1);
  renderCalendar(); renderEventList();
};

const monthSel=document.getElementById("month");
const yearSel=document.getElementById("year");

for(let m=0;m<12;m++){
  monthSel.innerHTML+=`<option value="${m}">${new Date(0,m).toLocaleString("default",{month:"long"})}</option>`;
}
for(let y=currentDate.getFullYear()-5;y<=currentDate.getFullYear()+5;y++){
  yearSel.innerHTML+=`<option value="${y}">${y}</option>`;
}

monthSel.value=currentDate.getMonth();
yearSel.value=currentDate.getFullYear();

monthSel.onchange=()=>{ currentDate.setMonth(+monthSel.value); renderCalendar(); renderEventList(); };
yearSel.onchange=()=>{ currentDate.setFullYear(+yearSel.value); renderCalendar(); renderEventList(); };

// INITIAL LOAD
loadEvents();
</script>
</body>
</html>
