<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brookfield Events Calendar [Alpha]</title>
<link rel="stylesheet" href="styles.css">
<style>
/* Highlight effect for scrolling */
.reminder-highlight {
  animation: highlightAnim 2s ease;
}
@keyframes highlightAnim {
  0% { background-color: #ffff99; }
  100% { background-color: #f0f0f0; }
}
</style>
</head>
<body>
<div class="wrapper">

  <h1>Brookfield Events Calendar [Alpha]</h1>

  <!-- CALENDAR -->
  <div id="calendar-container" class="container-calendar">
    <h3 id="monthAndYear"></h3>
    <div class="button-container-calendar">
      <button id="previous">‹</button>
      <button id="next">›</button>
    </div>

    <table class="table-calendar" id="calendar" data-lang="en">
      <thead id="thead-month"></thead>
      <tbody id="calendar-body"></tbody>
    </table>

    <div class="footer-container-calendar">
      <label for="month">Jump To: </label>
      <select id="month"></select>
      <select id="year"></select>
    </div>
  </div>

  <!-- EVENTS / REMINDERS -->
  <div id="reminder-section">
    <h3>Events & Reservations</h3>
    <ul id="reminderList"></ul>
  </div>

</div>

<script>
let currentDate = new Date();
let events = [];

// Load events from API
async function loadEvents(){
  try {
    const res = await fetch("/api/getEvents");
    events = await res.json();
    renderCalendar();
    renderEventList();
  } catch(err){
    console.error("Error loading events:", err);
  }
}

// Render event list below calendar
function renderEventList(){
  const ul = document.getElementById("reminderList");
  ul.innerHTML = "";
  events.sort((a,b)=>new Date(a.date)-new Date(b.date));
  events.forEach(e=>{
    const li = document.createElement("li");
    li.dataset.eventId = e._id; // for linking
    let typeClass = "event-default";
    if(e.eType==="socialCommitteeEvent") typeClass="event-social";
    else if(e.eType==="smallGroup") typeClass="event-small";
    else if(e.eType==="reservedPaid") typeClass="event-paid";
    else if(e.eType==="noSocialnoPaid") typeClass="event-large";

    li.className = "reminder-item";
    li.innerHTML = `
      <div class="reminder-header ${typeClass}">${e.title} (${e.eType})</div>
      <div class="reminder-details">
        <div class="eventTime">${e.date} ${e.startTime||''}-${e.endTime||''}</div>
        <div class="eventContact">${e.contactName || ''} ${e.contactInfo || ''}</div>
        <div class="eventDescription">${e.description || ''}</div>
      </div>
    `;

    // Toggle details accordion
    li.querySelector(".reminder-header").addEventListener("click", ()=>{
      const details = li.querySelector(".reminder-details");
      details.classList.toggle("show");
    });

    ul.appendChild(li);
  });
}

// Render calendar with colored dots
function renderCalendar(){
  const month = currentDate.getMonth();
  const year = currentDate.getFullYear();
  const monthAndYear = document.getElementById("monthAndYear");
  monthAndYear.textContent = `${currentDate.toLocaleString('default',{month:'long'})} ${year}`;

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();

  const tblBody = document.getElementById("calendar-body");
  tblBody.innerHTML = "";

  // Table header
  const thead = document.getElementById("thead-month");
  thead.innerHTML = "<tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>";

  let date = 1;
  for(let i=0;i<6;i++){
    const row = document.createElement("tr");
    for(let j=0;j<7;j++){
      const cell = document.createElement("td");
      if(i===0 && j<firstDay){ cell.innerHTML = ""; }
      else if(date>daysInMonth){ cell.innerHTML = ""; }
      else{
        cell.textContent = date;
        const cellDate = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;

        // Add event dots
        const eventsForDay = events.filter(ev=>ev.date===cellDate);
        if(eventsForDay.length){
          const dotContainer = document.createElement("div");
          dotContainer.className = "event-dots";
          eventsForDay.forEach(ev=>{
            const dot = document.createElement("span");
            let cls = "event-default";
            if(ev.eType==="socialCommitteeEvent") cls="event-social";
            else if(ev.eType==="smallGroup") cls="event-small";
            else if(ev.eType==="reservedPaid") cls="event-paid";
            else if(ev.eType==="noSocialnoPaid") cls="event-large";
            dot.className = "event-dot "+cls;
            dot.title = `${ev.title} (${ev.startTime||''}-${ev.endTime||''})`;

            // Scroll to reminder on click
            dot.addEventListener("click", ()=>{
              const reminder = document.querySelector(`#reminderList li[data-event-id='${ev._id}']`);
              if(reminder){
                reminder.scrollIntoView({behavior:"smooth", block:"start"});
                reminder.classList.add("reminder-highlight");
                setTimeout(()=>reminder.classList.remove("reminder-highlight"), 2000);
              }
            });

            dotContainer.appendChild(dot);
          });
          cell.appendChild(dotContainer);
        }

        date++;
      }
      row.appendChild(cell);
    }
    tblBody.appendChild(row);
    if(date>daysInMonth) break;
  }
}

// Navigation buttons
document.getElementById("previous").addEventListener("click", ()=>{
  currentDate.setMonth(currentDate.getMonth()-1);
  renderCalendar();
});
document.getElementById("next").addEventListener("click", ()=>{
  currentDate.setMonth(currentDate.getMonth()+1);
  renderCalendar();
});

// Jump selects
const monthSelect = document.getElementById("month");
const yearSelect = document.getElementById("year");
for(let m=0;m<12;m++){
  const opt = document.createElement("option");
  opt.value = m;
  opt.text = new Date(0,m).toLocaleString('default',{month:'long'});
  monthSelect.appendChild(opt);
}
for(let y=currentDate.getFullYear()-5;y<=currentDate.getFullYear()+5;y++){
  const opt = document.createElement("option");
  opt.value = y;
  opt.text = y;
  yearSelect.appendChild(opt);
}
monthSelect.value = currentDate.getMonth();
yearSelect.value = currentDate.getFullYear();
monthSelect.addEventListener("change", ()=>{ currentDate.setMonth(+monthSelect.value); renderCalendar(); });
yearSelect.addEventListener("change", ()=>{ currentDate.setFullYear(+yearSelect.value); renderCalendar(); });

loadEvents();
</script>
</body>
</html>
