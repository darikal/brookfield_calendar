<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brookfield Events Calendar [Beta]</title>
<link rel="stylesheet" href="styles.css">

<style>
/* ---------------- Header ---------------- */
#monthAndYear {
  text-align: center;
  font-size: 2rem;
  font-weight: 600;
  margin: 10px 0 15px;
}

/* ---------------- Reminder Highlight ---------------- */
.reminder-highlight {
  animation: highlightAnim 2s ease;
}
@keyframes highlightAnim {
  0% { background-color: #ffff99; }
  100% { background-color: #f0f0f0; }
}

.series-label {
  font-size: 0.8em;
  color: #555;
  margin-left: 5px;
}

/* ---------------- Calendar Cell ---------------- */
.table-calendar td {
  position: relative;
}

/* Only show diagonal when cell has events */
.table-calendar td.has-events::after {
  content: "";
  position: absolute;
  inset: 4px;
  background: linear-gradient(
    to top right,
    transparent 49%,
    rgba(0,0,0,0.2) 50%,
    transparent 51%
  );
  pointer-events: none;
}

/* ---------------- Dot Zones ---------------- */
.event-dots-am,
.event-dots-pm {
  position: absolute;
  display: flex;
  gap: 3px;
  flex-wrap: wrap;
}

.event-dots-am {
  top: 4px;
  left: 4px;
}

.event-dots-pm {
  bottom: 4px;
  right: 4px;
}

/* ---------------- Legend ---------------- */
.calendar-legend {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin: 10px 0 15px;
  font-size: 0.9em;
  color: #444;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-box {
  width: 14px;
  height: 14px;
  border: 1px solid #999;
  position: relative;
}

.legend-box::after {
  content: "";
  position: absolute;
  inset: 1px;
  background: linear-gradient(
    to top right,
    transparent 49%,
    rgba(0,0,0,0.3) 50%,
    transparent 51%
  );
}

/* ---------------- Mobile Fallback ---------------- */
@media (max-width: 640px) {
  .table-calendar td.has-events::after {
    display: none;
  }

  .event-dots-am,
  .event-dots-pm {
    position: static;
    justify-content: center;
  }

  .event-dots-am,
  .event-dots-pm {
    margin-top: 4px;
  }
}
</style>
</head>

<body>
<div class="wrapper">
  <h1>Brookfield Events Calendar [Beta]</h1>

  <div class="container-calendar">
    <h3 id="monthAndYear"></h3>

    <!-- Legend -->
    <div class="calendar-legend">
      <div class="legend-item">
        <div class="legend-box"></div>
        <span>AM (before noon)</span>
      </div>
      <div class="legend-item">
        <div class="legend-box"></div>
        <span>PM (noon & after)</span>
      </div>
    </div>

    <div class="button-container-calendar">
      <button id="previous">‹</button>
      <button id="next">›</button>
    </div>

    <table class="table-calendar">
      <thead id="thead-month"></thead>
      <tbody id="calendar-body"></tbody>
    </table>

    <div class="footer-container-calendar">
      <label>Jump To:</label>
      <select id="month"></select>
      <select id="year"></select>
    </div>
  </div>

  <div id="reminder-section">
    <h3>Events & Reservations</h3>
    <ul id="reminderList"></ul>
  </div>
</div>

<script>
let currentDate = new Date();
let events = [];

/* ---------------- Helpers ---------------- */

function formatTime12h(timeStr) {
  if (!timeStr) return "";
  const [h, m] = timeStr.split(":").map(Number);
  const period = h >= 12 ? "PM" : "AM"; // Noon is PM
  const hour12 = h % 12 || 12;
  return `${hour12}:${String(m).padStart(2,"0")} ${period}`;
}

function isAM(startTime) {
  if (!startTime) return true;
  return Number(startTime.split(":")[0]) < 12;
}

/* ---------------- Load ---------------- */

async function loadEvents() {
  const res = await fetch("/api/getEvents");
  events = await res.json();
  renderCalendar();
  renderEventList();
}

/* ---------------- Event List ---------------- */

function renderEventList() {
  const ul = document.getElementById("reminderList");
  ul.innerHTML = "";

  const m = currentDate.getMonth() + 1;
  const y = currentDate.getFullYear();

  events
    .filter(e => {
      const [ey, em] = e.date.split("-").map(Number);
      return ey === y && em === m;
    })
    .sort((a,b)=> new Date(a.date) - new Date(b.date))
    .forEach(e => {

      let cls="event-default";
      if(e.eType==="socialCommitteeEvent") cls="event-social";
      else if(e.eType==="smallGroup") cls="event-small";
      else if(e.eType==="reservedPaid") cls="event-paid";
      else if(e.eType==="noSocialnoPaid") cls="event-large";
      else if(e.eType==="boardMeeting") cls="event-board";

      const li=document.createElement("li");
      li.className="reminder-item";
      li.dataset.key=`${e._id}-${e.date}`;

      li.innerHTML=`
        <div class="reminder-header ${cls}">
          ${e.title} – ${e.date}
          ${e.seriesId ? '<span class="series-label">(Series)</span>' : ''}
        </div>
        <div class="reminder-details">
          <div>
            ${formatTime12h(e.startTime)}
            ${e.endTime ? "– " + formatTime12h(e.endTime) : ""}
          </div>
          <div>${e.contactName||""} ${e.contactInfo||""}</div>
          <div>${e.description||""}</div>
        </div>
      `;

      li.querySelector(".reminder-header").onclick=()=>{
        li.querySelector(".reminder-details").classList.toggle("show");
      };

      ul.appendChild(li);
    });
}

/* ---------------- Calendar ---------------- */

function renderCalendar() {
  const month=currentDate.getMonth();
  const year=currentDate.getFullYear();

  document.getElementById("monthAndYear").textContent =
    currentDate.toLocaleString("default",{month:"long"})+" "+year;

  document.getElementById("thead-month").innerHTML =
    "<tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>";

  const body=document.getElementById("calendar-body");
  body.innerHTML="";

  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  let date=1;

  for(let i=0;i<6;i++){
    const row=document.createElement("tr");

    for(let j=0;j<7;j++){
      const cell=document.createElement("td");

      if((i===0&&j<firstDay)||date>daysInMonth){
        cell.innerHTML="";
      } else {
        cell.textContent=date;

        const dStr=`${year}-${String(month+1).padStart(2,"0")}-${String(date).padStart(2,"0")}`;
        const dayEvents=events.filter(e=>e.date===dStr);

        if(dayEvents.length){
          cell.classList.add("has-events");

          const am=document.createElement("div");
          const pm=document.createElement("div");
          am.className="event-dots-am";
          pm.className="event-dots-pm";

          dayEvents.forEach(e=>{
            const dot=document.createElement("span");
            let cls="event-default";
            if(e.eType==="socialCommitteeEvent") cls="event-social";
            else if(e.eType==="smallGroup") cls="event-small";
            else if(e.eType==="reservedPaid") cls="event-paid";
            else if(e.eType==="noSocialnoPaid") cls="event-large";
            else if(e.eType==="boardMeeting") cls="event-board";

            dot.className="event-dot "+cls;

            dot.onclick=ev=>{
              ev.stopPropagation();
              const li=document.querySelector(`[data-key='${e._id}-${e.date}']`);
              if(li){
                li.scrollIntoView({behavior:"smooth"});
                li.classList.add("reminder-highlight");
                setTimeout(()=>li.classList.remove("reminder-highlight"),2000);
              }
            };

            (isAM(e.startTime)?am:pm).appendChild(dot);
          });

          if(am.children.length) cell.appendChild(am);
          if(pm.children.length) cell.appendChild(pm);
        }

        date++;
      }

      row.appendChild(cell);
    }

    body.appendChild(row);
    if(date>daysInMonth) break;
  }
}

/* ---------------- Navigation ---------------- */

document.getElementById("previous").onclick=()=>{
  currentDate.setMonth(currentDate.getMonth()-1);
  renderCalendar(); renderEventList();
};

document.getElementById("next").onclick=()=>{
  currentDate.setMonth(currentDate.getMonth()+1);
  renderCalendar(); renderEventList();
};

const monthSel=document.getElementById("month");
const yearSel=document.getElementById("year");

for(let m=0;m<12;m++)
  monthSel.innerHTML+=`<option value="${m}">${new Date(0,m).toLocaleString("default",{month:"long"})}</option>`;

for(let y=currentDate.getFullYear()-5;y<=currentDate.getFullYear()+5;y++)
  yearSel.innerHTML+=`<option value="${y}">${y}</option>`;

monthSel.value=currentDate.getMonth();
yearSel.value=currentDate.getFullYear();

monthSel.onchange=()=>{currentDate.setMonth(+monthSel.value);renderCalendar();renderEventList();};
yearSel.onchange=()=>{currentDate.setFullYear(+yearSel.value);renderCalendar();renderEventList();};

loadEvents();
</script>
</body>
</html>
