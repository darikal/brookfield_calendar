<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Brookfield Events – Admin</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>
<div class="wrapper">

  <!-- LOGIN -->
  <div id="loginBox">
    <h2>Admin Login</h2>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <!-- ADMIN -->
  <div id="adminPanel" style="display:none;">
    <h1>Brookfield Events – Admin</h1>
    <button class="danger" onclick="logout()">Logout</button>

    <h3>Add / Edit Event</h3>

    <select id="eventTypeMajor">
      <option value="" hidden>--- Event Type ---</option>
      <option value="social">Social Committee Hosted Event</option>
      <option value="small">Small Group Event</option>
      <option value="paid">Paid Reservation</option>
      <option value="large">Large Group Event</option>
    </select>

    <input type="date" id="eventDate">

    <div class="time-input">
      <label>Start Time</label>
      <input type="time" id="startTime">
      <label>End Time</label>
      <input type="time" id="endTime">
    </div>

    <input id="groupSize" placeholder="Group size (optional)">

    <label>
      <input type="checkbox" id="recurCheckbox"> Recurring Event
    </label>

    <div id="recurring" style="display:none;">
      <select id="recurWhen">
        <option value="week">Weekly</option>
        <option value="biWeek">Bi-Weekly</option>
        <option value="month">Monthly</option>
      </select>

      <label>Repeat for</label>
      <input type="number" id="recurLengthNum" placeholder="10">
      <select id="recurLength">
        <option value="week">Weeks</option>
        <option value="month">Months</option>
      </select>
    </div>

    <input id="contactName" placeholder="Contact name">
    <input id="contactInfo" placeholder="Email or phone">

    <input id="eventTitle" placeholder="Event title">
    <input id="eventDescription" placeholder="Event description">

    <select id="walkInWelcome">
      <option value="" hidden>--- Walk Ins ---</option>
      <option value="Open">Open to walk ins</option>
      <option value="Closed">Closed</option>
      <option value="signUpRequired">Signup Required</option>
    </select>

    <input id="signUp" placeholder="Signup instructions">

    <button id="saveBtn" onclick="saveEvent()">Save Event</button>
    <button onclick="cancelEdit()" style="display:none;" id="cancelEditBtn">Cancel Edit</button>

    <hr>

    <h3>Existing Events</h3>
    <ul id="eventList"></ul>
  </div>
</div>

<script>
let currentAdmin = null;
let editingId = null;

async function login() {
  const res = await fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: username.value,
      password: password.value
    })
  });

  if (!res.ok) {
    alert("Login failed");
    return;
  }

  currentAdmin = username.value;
  loginBox.style.display = "none";
  adminPanel.style.display = "block";
  loadEvents();
}

function logout() {
  document.cookie = "session=; Max-Age=0; path=/";
  location.reload();
}

async function loadEvents() {
  const res = await fetch("/api/getEvents");
  const events = await res.json();
  eventList.innerHTML = "";

  events.forEach(ev => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${ev.title}</strong>
      ${ev.date} ${ev.startTime}-${ev.endTime}<br>
      <small>Type: ${ev.eventType} | Created by: ${ev.createdByAdmin || "N/A"}</small><br>
      <button onclick="editEvent('${ev._id}')">Edit</button>
      <button class="danger" onclick="deleteEvent('${ev._id}')">Delete</button>
    `;
    eventList.appendChild(li);
  });
}

async function saveEvent() {
  const payload = {
    _id: editingId,
    eventType: eventTypeMajor.value,
    date: eventDate.value,
    startTime: startTime.value,
    endTime: endTime.value,
    groupSize: groupSize.value,
    title: eventTitle.value,
    description: eventDescription.value,
    recurring: recurCheckbox.checked,
    recurWhen: recurWhen.value,
    recurLengthNum: recurLengthNum.value,
    recurLength: recurLength.value,
    contactName: contactName.value,
    contactInfo: contactInfo.value,
    walkIns: walkInWelcome.value,
    signUp: signUp.value,
    createdByAdmin: currentAdmin
  };

  const res = await fetch(editingId ? "/api/updateEvent" : "/api/addEvent", {
    method: editingId ? "PUT" : "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    alert("Save failed");
    return;
  }

  cancelEdit();
  loadEvents();
}

function editEvent(id) {
  fetch("/api/getEvents")
    .then(r => r.json())
    .then(events => {
      const ev = events.find(e => e._id === id);
      if (!ev) return;

      editingId = ev._id;
      eventTypeMajor.value = ev.eventType;
      eventDate.value = ev.date;
      startTime.value = ev.startTime;
      endTime.value = ev.endTime;
      groupSize.value = ev.groupSize || "";
      eventTitle.value = ev.title;
      eventDescription.value = ev.description;

      saveBtn.textContent = "Update Event";
      cancelEditBtn.style.display = "inline";
    });
}

function cancelEdit() {
  editingId = null;
  saveBtn.textContent = "Save Event";
  cancelEditBtn.style.display = "none";
  document.querySelectorAll("#adminPanel input, #adminPanel select")
    .forEach(el => el.value = "");
}

async function deleteEvent(id) {
  if (!confirm("Delete this event?")) return;
  await fetch("/api/deleteEvent", {
    method: "DELETE",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id })
  });
  loadEvents();
}

recurCheckbox.addEventListener("change", () => {
  recurring.style.display = recurCheckbox.checked ? "block" : "none";
});
</script>
</body>
</html>
