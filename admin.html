<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brookfield Admin Console</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- LOGIN -->
<div class="login-wrapper" id="loginWrapper">
  <h1>Admin Login</h1>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color:red"></p>
</div>

<!-- ADMIN -->
<div class="admin-wrapper hidden" id="adminWrapper">
  <h1>Admin Console</h1>
  <button onclick="logout()">Logout</button>

  <h2>Events</h2>

  <div class="admin-toolbar">
    <input type="text" id="searchEvent" placeholder="Search events">
    <select id="sortEvent">
      <option value="dateAsc">Date ↑</option>
      <option value="dateDesc">Date ↓</option>
      <option value="type">Type</option>
      <option value="title">Title</option>
    </select>
    <button onclick="startNewEvent()">+ New Event</button>
  </div>

  <!-- FORM -->
  <div id="eventForm" class="hidden">
    <h2 id="formTitle">Create Event</h2>

    <select id="eventType">
      <option value="" hidden>--- Event Type ---</option>
      <option value="socialCommitteeEvent">Social Committee</option>
      <option value="smallGroup">Small Group</option>
      <option value="reservedPaid">Paid Reservation</option>
      <option value="noSocialnoPaid">Large Group</option>
    </select>

    <input type="date" id="eventDate">

    <div class="time-input">
      <label>Start</label>
      <input type="time" id="startTime">
      <label>End</label>
      <input type="time" id="endTime">
    </div>

    <input type="text" id="groupSize" placeholder="Group size">

    <input type="text" id="eventTitle" placeholder="Event Title">
    <input type="text" id="eventDescription" placeholder="Description">

    <button id="saveBtn" onclick="saveEvent()">Save Event</button>
    <button class="danger" onclick="cancelEdit()">Cancel</button>
  </div>

  <!-- TABLE -->
  <table class="admin-events-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Title</th>
        <th>Type</th>
        <th>Added By</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="eventsBody"></tbody>
  </table>
</div>

<script>
let currentUserRole = null;
let currentUsername = null;
let editingEventId = null;
let allEvents = [];

/* ---------------- SESSION ---------------- */
window.addEventListener("DOMContentLoaded", async () => {
  try {
    const res = await fetch("/api/session");
    if (res.ok) {
      const data = await res.json();
      currentUserRole = data.role;
      currentUsername = data.username;
      showAdmin();
      loadEvents();
    }
  } catch {}
});

/* ---------------- LOGIN ---------------- */
document.getElementById("loginBtn").onclick = login;
document.getElementById("password").addEventListener("keydown", e => {
  if (e.key === "Enter") login();
});

async function login() {
  const res = await fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: username.value,
      password: password.value
    })
  });

  const data = await res.json();
  if (!res.ok) {
    loginError.textContent = data.error || "Login failed";
    return;
  }

  currentUserRole = data.role;
  currentUsername = username.value;
  showAdmin();
  loadEvents();
}

function logout() {
  fetch("/api/logout").then(() => location.reload());
}

function showAdmin() {
  loginWrapper.classList.add("hidden");
  adminWrapper.classList.remove("hidden");
}

/* ---------------- EVENTS ---------------- */
async function loadEvents() {
  const res = await fetch("/api/getEvents?admin=true");
  allEvents = await res.json();
  renderEvents();
}

function renderEvents() {
  const term = searchEvent.value.toLowerCase();
  const sort = sortEvent.value;

  let events = allEvents.filter(e =>
    e.title.toLowerCase().includes(term)
  );

  events.sort((a,b)=>{
    if(sort==="dateAsc") return new Date(a.date)-new Date(b.date);
    if(sort==="dateDesc") return new Date(b.date)-new Date(a.date);
    if(sort==="type") return a.eType.localeCompare(b.eType);
    if(sort==="title") return a.title.localeCompare(b.title);
  });

  eventsBody.innerHTML = "";
  events.forEach(ev=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ev.date}</td>
      <td>${ev.title}</td>
      <td>${ev.eType}</td>
      <td>${ev.addedBy||""}</td>
      <td>
        <button onclick="editEvent('${ev._id}')">Edit</button>
        <button class="danger" onclick="deleteEvent('${ev._id}')">Delete</button>
      </td>
    `;
    eventsBody.appendChild(tr);
  });
}

/* ---------------- FORM ---------------- */
function startNewEvent() {
  editingEventId = null;
  eventForm.classList.remove("hidden");
  formTitle.textContent = "Create Event";
  saveBtn.textContent = "Save Event";
  eventForm.querySelectorAll("input,select").forEach(i=>i.value="");
}

function editEvent(id) {
  const ev = allEvents.find(e=>e._id===id);
  if(!ev) return;

  editingEventId = id;
  eventForm.classList.remove("hidden");
  formTitle.textContent = "Edit Event";
  saveBtn.textContent = "Update Event";

  eventType.value = ev.eType;
  eventDate.value = ev.date;
  startTime.value = ev.startTime||"";
  endTime.value = ev.endTime||"";
  groupSize.value = ev.groupSize||"";
  eventTitle.value = ev.title;
  eventDescription.value = ev.description||"";

  window.scrollTo({top:0,behavior:"smooth"});
}

function cancelEdit() {
  eventForm.classList.add("hidden");
  editingEventId = null;
}

/* ---------------- SAVE ---------------- */
async function saveEvent() {
  const payload = {
    id: editingEventId,
    eType: eventType.value,
    date: eventDate.value,
    title: eventTitle.value,
    description: eventDescription.value,
    startTime: startTime.value,
    endTime: endTime.value,
    groupSize: groupSize.value,
    addedBy: currentUsername
  };

  const res = await fetch(editingEventId?"/api/updateEvent":"/api/addEvent",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    alert("Save failed");
    return;
  }

  cancelEdit();
  loadEvents();
}

async function deleteEvent(id){
  if(!confirm("Delete this event?")) return;
  await fetch("/api/deleteEvent",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({id})
  });
  loadEvents();
}

/* ---------------- UI ---------------- */
searchEvent.oninput = renderEvents;
sortEvent.onchange = renderEvents;
</script>

</body>
</html>
