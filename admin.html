<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brookfield Admin Console</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- LOGIN -->
<div class="login-wrapper" id="loginWrapper">
  <h1>Admin Login</h1>
  <form id="loginForm">
    <input type="text" id="username" placeholder="Username" required />
    <input type="password" id="password" placeholder="Password" required />
    <button type="submit">Login</button>
  </form>
  <p id="loginError" style="color:red"></p>
</div>

<!-- ADMIN -->
<div class="admin-wrapper hidden" id="adminWrapper">
  <h1>Admin Console</h1>
  <button onclick="logout()">Logout</button>

  <h2>Create / Edit Event</h2>

  <!-- SEARCH / SORT -->
  <div class="admin-toolbar">
    <input type="text" id="searchEvent" placeholder="Search events…">
    <select id="sortEvent">
      <option value="dateAsc">Date ↑</option>
      <option value="dateDesc">Date ↓</option>
      <option value="title">Title</option>
      <option value="type">Type</option>
    </select>
  </div>

  <!-- EVENT TYPE -->
  <select id="eventType">
    <option value="" hidden>--- Select Event Type ---</option>
    <option value="socialCommitteeEvent">Social Committee</option>
    <option value="smallGroup">Small Group</option>
    <option value="noSocialnoPaid">Large Group</option>
    <option value="reservedPaid">Paid Reservation</option>
  </select>

  <!-- EVENT FORM (HIDDEN UNTIL TYPE SELECTED) -->
  <div id="eventForm" class="hidden">

    <input type="date" id="eventDate">

    <div class="time-input">
      <label>Start</label>
      <input type="time" id="startTime">
      <label>End</label>
      <input type="time" id="endTime">
    </div>

    <div class="group-size-wrapper">
      <label>Group Size</label>
      <input type="text" id="groupSize" placeholder="10–15">
    </div>

    <!-- CONTACT INFO -->
    <h4>Contact Information</h4>
    <input type="text" id="contactName" placeholder="Contact Name">
    <input type="text" id="contactInfo" placeholder="Phone or Email">

    <!-- RECURRING -->
    <label>
      <input type="checkbox" id="recurCheckbox">
      Recurring Event
    </label>

    <div id="recurringOptions" class="hidden">
      <select id="recurWhen">
        <option value="week">Weekly</option>
        <option value="biWeek">Bi-Weekly</option>
        <option value="month">Monthly</option>
      </select>

      <label>For the next</label>
      <input type="number" id="recurLengthNum" min="1" max="52">
      <select id="recurLength">
        <option value="week">Weeks</option>
        <option value="month">Months</option>
      </select>
    </div>

    <input type="text" id="eventTitle" placeholder="Event Title">
    <input type="text" id="eventDescription" placeholder="Event Description">

    <!-- PAID -->
    <div id="paidInfo" class="hidden">
      <h4>Paid Reservation</h4>
      <input type="text" id="residentName" placeholder="Resident Name">
      <input type="text" id="residentAddress" placeholder="Resident Address">
      <label>
        <input type="checkbox" id="acceptTerms">
        Accept Terms
      </label>
    </div>

    <button id="saveBtn" onclick="saveEvent()">Save Event</button>
  </div>

  <!-- EVENTS LIST -->
  <h2>Existing Events</h2>
  <table class="admin-events-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Title</th>
        <th>Type</th>
        <th>Added By</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="eventsTable"></tbody>
  </table>
</div>

<script>
let currentUser = null;
let editId = null;

/* SESSION */
window.addEventListener("DOMContentLoaded", async () => {
  const res = await fetch("/api/session");
  if(res.ok){
    const data = await res.json();
    currentUser = data;
    loginWrapper.classList.add("hidden");
    adminWrapper.classList.remove("hidden");
    loadEvents();
  }
});

/* LOGIN */
loginForm.addEventListener("submit", async e => {
  e.preventDefault();
  const res = await fetch("/api/login",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      username: username.value,
      password: password.value
    })
  });
  const data = await res.json();
  if(!res.ok){
    loginError.textContent = data.error || "Login failed";
    return;
  }
  location.reload();
});

/* LOGOUT */
async function logout(){
  await fetch("/api/logout");
  location.reload();
}

/* FORM VISIBILITY */
eventType.addEventListener("change",()=>{
  eventForm.classList.toggle("hidden", !eventType.value);
  paidInfo.classList.toggle("hidden", eventType.value !== "reservedPaid");
});

recurCheckbox.addEventListener("change",()=>{
  recurringOptions.classList.toggle("hidden", !recurCheckbox.checked);
});

/* LOAD EVENTS */
async function loadEvents(){
  const res = await fetch("/api/getEvents?admin=true");
  let events = await res.json();

  const search = searchEvent.value.toLowerCase();
  events = events.filter(e => e.title.toLowerCase().includes(search));

  events.sort((a,b)=>{
    if(sortEvent.value==="dateAsc") return new Date(a.date)-new Date(b.date);
    if(sortEvent.value==="dateDesc") return new Date(b.date)-new Date(a.date);
    if(sortEvent.value==="title") return a.title.localeCompare(b.title);
    return a.eType.localeCompare(b.eType);
  });

  eventsTable.innerHTML="";
  events.forEach(ev=>{
    eventsTable.innerHTML += `
      <tr>
        <td>${ev.date}</td>
        <td>${ev.title}</td>
        <td>${ev.eType}</td>
        <td>${ev.addedBy||"—"}</td>
        <td>
          <button onclick="editEvent('${ev._id}')">Edit</button>
          <button onclick="deleteEvent('${ev._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

/* EDIT */
function editEvent(id){
  fetch("/api/getEvents?admin=true")
    .then(r=>r.json())
    .then(events=>{
      const ev = events.find(e=>e._id===id);
      editId=id;

      eventType.value=ev.eType;
      eventForm.classList.remove("hidden");

      eventDate.value=ev.date;
      startTime.value=ev.startTime||"";
      endTime.value=ev.endTime||"";
      groupSize.value=ev.groupSize||"";
      contactName.value=ev.contactName||"";
      contactInfo.value=ev.contactInfo||"";
      eventTitle.value=ev.title;
      eventDescription.value=ev.description||"";

      recurCheckbox.checked=!!ev.recurring;
      recurringOptions.classList.toggle("hidden", !ev.recurring);
      recurWhen.value=ev.recurWhen||"week";
      recurLengthNum.value=ev.recurLengthNum||"";
      recurLength.value=ev.recurLength||"week";

      paidInfo.classList.toggle("hidden", ev.eType!=="reservedPaid");
      residentName.value=ev.residentName||"";
      residentAddress.value=ev.residentAddress||"";
    });
}

/* SAVE */
async function saveEvent(){
  const payload = {
    id: editId,
    eType: eventType.value,
    date: eventDate.value,
    startTime: startTime.value,
    endTime: endTime.value,
    groupSize: groupSize.value,
    title: eventTitle.value,
    description: eventDescription.value,
    contactName: contactName.value,
    contactInfo: contactInfo.value,
    recurring: recurCheckbox.checked,
    recurWhen: recurWhen.value,
    recurLengthNum: recurLengthNum.value,
    recurLength: recurLength.value,
    addedBy: currentUser.username
  };

  await fetch("/api/addEvent",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  editId=null;
  loadEvents();
}

/* DELETE */
async function deleteEvent(id){
  if(!confirm("Delete this event?")) return;
  await fetch("/api/deleteEvent",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({id})
  });
  loadEvents();
}

searchEvent.addEventListener("input", loadEvents);
sortEvent.addEventListener("change", loadEvents);
</script>
</body>
</html>
